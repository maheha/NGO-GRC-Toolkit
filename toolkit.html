<!--
    NGO GRC Toolkit, a guided tool to build an ISO 27001 Risk Register & DPIA.
    Version 3.2
    Copyright (C) 2025 Mathias Hagstrøm <maheha@gmail.com>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGO GRC Toolkit by Mathias Hagstrøm (v3.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: Inter, sans-serif; background-color: #111827; color: #D1D5DB; }
        .step-container { display: none; }
        .step-container.active { display: block; }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
        .list-item { transition: background-color 0.2s; }
        .list-item:hover { background-color: #374151; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background-color: #1f2937; color: #e5e7eb; padding: 0.75rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); border: 1px solid #374151; transform: translateX(120%); transition: transform 0.3s ease-in-out; max-width: 320px; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid #22c55e; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.info { border-left: 4px solid #3b82f6; }
        .info-icon { cursor: pointer; text-align: center; font-weight: 600; }
    </style>
</head>
<body class="antialiased text-gray-200">

    <div id="toast-container"></div>

    <div class="container mx-auto max-w-5xl p-4 md:p-8">
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-sky-400 to-purple-500 text-transparent bg-clip-text">NGO GRC Toolkit</h1>
            <p class="mt-2 text-gray-400">A guided tool to build your ISO 27001 Risk Register & DPIA</p>
            <p class="text-xs text-gray-500 mt-2">Version 3.2 | by Mathias Hagstrøm</p>
        </header>

        <div class="flex justify-center flex-wrap gap-4 mb-8">
            <button id="saveBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Save Session (.json)
            </button>
            <label class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-500 transition-colors text-sm flex items-center cursor-pointer">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                Load Session (.json)
                <input type="file" id="jsonLoader" class="hidden" accept=".json">
            </label>
             <button id="importCsvBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-500 transition-colors text-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                Import Risks (.csv)
            </button>
            <input type="file" id="csvLoader" class="hidden" accept=".csv, text/csv">
        </div>

        <div class="w-full bg-gray-700 rounded-full h-2.5 mb-8">
            <div id="progressBar" class="bg-sky-500 h-2.5 rounded-full progress-bar-fill" style="width: 10%"></div>
        </div>
        
        <main class="bg-gray-800/50 border border-gray-700 rounded-2xl p-6 md:p-8 min-h-[500px]">
            <div id="step-1" class="step-container active">
                <div class="flex justify-between items-start">
                     <div>
                        <h2 class="text-2xl font-semibold text-sky-400 mb-4">Step 1: Tell Us About Your NGO</h2>
                        <p class="text-gray-400 mb-6">Let's start by personalizing the report with some basic information.</p>
                     </div>
                     <button id="guideBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors text-sm flex items-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        Quick Guide
                     </button>
                </div>
                <div class="bg-gray-900/50 border border-sky-800 rounded-lg p-4 mb-6">
                    <h4 class="font-bold text-sky-400 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5.002a11.954 11.954 0 01-1.616 5.378A11.954 11.954 0 0110 18.056a11.954 11.954 0 019.45-7.676 11.954 11.954 0 01-1.616-5.378A11.954 11.954 0 0110 1.944zM9 11a1 1 0 112 0v2a1 1 0 11-2 0v-2zm1-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>Your Privacy is Paramount</h4>
                    <p class="text-sm text-gray-400 mt-2">This tool runs entirely in your browser. All data you enter <strong class="text-gray-300">never leaves your computer</strong>. It is not saved, stored, or sent to any server. When you close this page, your data is gone unless you save it. No cookies are used.</p>
                </div>
                <div class="space-y-4">
                    <div><label for="ngoName" class="block text-sm font-medium text-gray-300">NGO Name</label><input type="text" id="ngoName" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm p-2" placeholder="e.g., Global Aid Responders"></div>
                    <div><label for="ngoMission" class="block text-sm font-medium text-gray-300">Primary Mission / Activity</label><textarea id="ngoMission" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 sm:text-sm p-2" placeholder="e.g., Providing medical aid and shelter to refugees in high-risk zones."></textarea></div>
                </div>
            </div>

            <div id="step-2" class="step-container">
                <h2 class="text-2xl font-semibold text-sky-400 mb-2">Step 2: ISO 27001 Risk Register</h2>
                <p class="text-gray-400 mb-6">Identify assets, define risks, assign treatments, and select controls.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-2">1. Identify Your Assets</h3>
                        <input type="text" id="assetInput" placeholder="e.g., Beneficiary Database" class="w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        <div class="flex items-center mt-2">
                           <select id="assetCategoryInput" class="w-full bg-gray-700 border-gray-600 rounded-md p-2">
                                <option value="data">Data/Information</option>
                                <option value="hardware">Hardware</option>
                                <option value="software">Software</option>
                                <option value="people">People</option>
                                <option value="facility">Physical Facility</option>
                           </select>
                           <span id="assetCatInfo" class="info-icon text-xs text-gray-400 border border-gray-500 rounded-full w-5 h-5 flex items-center justify-center ml-2 flex-shrink-0" title="An asset is anything of value. Data, hardware (laptops), software, people, and physical locations can all be assets.">?</span>
                        </div>
                        <button id="addAssetBtn" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors mt-2">Add Asset</button>
                        <div id="assetList" class="bg-gray-900/50 p-2 rounded-md min-h-[200px] max-h-[200px] overflow-y-auto mt-2"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2">2. Add Risks to Selected Asset</h3>
                        <div id="riskSection" class="hidden">
                            <p class="text-sm mb-2">For Asset: <strong id="selectedAsset" class="text-sky-400"></strong></p>
                            <input type="text" id="riskDescription" placeholder="Risk Description (e.g., Data breach via phishing)" class="w-full bg-gray-700 border-gray-600 rounded-md p-2 mb-2">
                            <div class="flex items-center mb-2">
                                <select id="threatCategoryInput" class="w-full bg-gray-700 border-gray-600 rounded-md p-2"><option value="">Select Threat Category...</option><option value="malicious">Malicious Act</option><option value="accidental">Accidental</option><option value="environmental">Environmental</option><option value="technical">Technical Failure</option></select>
                                <span id="threatCatInfo" class="info-icon text-xs text-gray-400 border border-gray-500 rounded-full w-5 h-5 flex items-center justify-center ml-2 flex-shrink-0" title="A threat is what could cause harm. Malicious (hacker), Accidental (mistake), Environmental (flood), or Technical (server crash).">?</span>
                            </div>
                            <div class="flex items-center mb-2">
                                <select id="vulnerabilityCategoryInput" class="w-full bg-gray-700 border-gray-600 rounded-md p-2"><option value="">Select Vulnerability Category...</option><option value="technical">Technical</option><option value="physical">Physical</option><option value="human">Human/Procedural</option></select>
                                <span id="vulnCatInfo" class="info-icon text-xs text-gray-400 border border-gray-500 rounded-full w-5 h-5 flex items-center justify-center ml-2 flex-shrink-0" title="A vulnerability is a weakness a threat can exploit. Technical (buggy code), Physical (unlocked door), or Human (lack of training).">?</span>
                            </div>
                            <div class="flex items-center gap-x-2 mb-2">
                                <label class="text-sm">Impact (1-5)</label>
                                <span id="impactInfo" class="info-icon text-xs text-gray-400 border border-gray-500 rounded-full w-4 h-4 flex items-center justify-center" title="How bad will it be if this risk occurs?&#10;1: Insignificant&#10;2: Minor&#10;3: Moderate&#10;4: Major&#10;5: Critical">(?)</span>
                                <input type="number" id="impactInput" min="1" max="5" value="3" class="w-16 bg-gray-700 border-gray-600 rounded-md p-2">
                                <label class="text-sm ml-4">Likelihood (1-5)</label>
                                <span id="likelihoodInfo" class="info-icon text-xs text-gray-400 border border-gray-500 rounded-full w-4 h-4 flex items-center justify-center" title="How likely is it that this risk will occur?&#10;1: Rare&#10;2: Unlikely&#10;3: Possible&#10;4: Likely&#10;5: Almost Certain">(?)</span>
                                <input type="number" id="likelihoodInput" min="1" max="5" value="3" class="w-16 bg-gray-700 border-gray-600 rounded-md p-2">
                            </div>
                            <button id="addRiskBtn" class="w-full bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">Add Risk</button>
                        </div>
                    </div>
                </div>
                <!-- New Duplicate Finder Section -->
                <div class="mt-6 flex items-center gap-4">
                     <h3 class="text-lg font-semibold">Risk Register</h3>
                     <button id="findDuplicatesBtn" class="bg-yellow-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-yellow-700 transition-colors text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        Find Duplicates
                     </button>
                     <button id="clearHighlightsBtn" class="hidden bg-gray-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-gray-500 transition-colors text-sm">Clear Highlights</button>
                </div>
                <div id="riskRegisterTableContainer" class="mt-2 max-h-[250px] overflow-y-auto"></div>
            </div>

            <div id="step-3" class="step-container">
                 <h2 class="text-2xl font-semibold text-sky-400 mb-4">Step 3: Data Protection Impact Assessment (DPIA)</h2>
                 <p class="text-gray-400 mb-6">Answer these questions to assess the privacy impact of your activities. Be descriptive.</p>
                 <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                    <div><label for="dpiaQ1" class="block font-medium text-gray-300">1. Describe the nature of the data processing.</label><p class="text-xs text-gray-500 mb-1">What personal data are you collecting? Who are you collecting it from? How will you store it?</p><textarea id="dpiaQ1" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2"></textarea></div>
                    <div><label for="dpiaQ2" class="block font-medium text-gray-300">2. Assess the necessity and proportionality.</label><p class="text-xs text-gray-500 mb-1">Why is this data processing necessary to achieve your mission? Are you collecting the minimum amount of data required?</p><textarea id="dpiaQ2" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2"></textarea></div>
                    <div><label for="dpiaQ3" class="block font-medium text-gray-300">3. Identify and assess risks to individuals.</label><p class="text-xs text-gray-500 mb-1">What are the potential harms to individuals if this data is leaked, lost, or misused (e.g., physical harm, discrimination)?</p><textarea id="dpiaQ3" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2"></textarea></div>
                    <div><label for="dpiaQ4" class="block font-medium text-gray-300">4. Identify measures to mitigate the risks.</label><p class="text-xs text-gray-500 mb-1">What technical (e.g., encryption, access controls) and organizational (e.g., staff training, policies) measures will you put in place?</p><textarea id="dpiaQ4" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2"></textarea></div>
                 </div>
            </div>

            <div id="step-4" class="step-container">
                 <h2 class="text-2xl font-semibold text-sky-400 mb-4">Step 4: Review & Export Your Report</h2>
                 <p class="text-gray-400 mb-6">Review the information below. When you're ready, download your GRC report.</p>
                 <div id="reviewSection" class="space-y-6 max-h-[400px] overflow-y-auto pr-2">
                     <div><h3 class="font-semibold text-lg text-purple-400 border-b border-gray-600 pb-1 mb-2">DPIA Summary</h3><div id="dpiaReview" class="text-sm space-y-3"></div></div>
                     <div><h3 class="font-semibold text-lg text-sky-400 border-b border-gray-600 pb-1 mb-2">Risk Register</h3><div id="riskRegisterReview"></div></div>
                 </div>
                 <div class="mt-8 flex flex-col items-center gap-y-4">
                    <div class="flex justify-center space-x-4">
                        <button id="downloadPdfBtn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Download PDF Report</button>
                        <button id="downloadCsvBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Download CSV Data</button>
                    </div>
                    <button id="templateCsvBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Download CSV Template
                    </button>
                 </div>
            </div>
        </main>

        <footer class="mt-8 flex justify-between items-center">
            <button id="prevBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Previous</button>
            <div class="text-center">
                 <div id="stepIndicator" class="text-sm text-gray-400">Step 1 of 4</div>
                 <a href="https://www.gnu.org/licenses/gpl-3.0.en.html" target="_blank" class="text-xs text-gray-500 hover:text-sky-400 transition-colors">
                     Released under GPL v3.0 by Mathias Hagstrøm
                 </a>
            </div>
            <button id="nextBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors">Next</button>
        </footer>
    </div>
    
    <div id="controlSelectionModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="modal-content bg-gray-800 w-full max-w-3xl rounded-lg shadow-xl p-6 transform -translate-y-10 border border-gray-600">
            <h3 class="text-xl font-bold text-sky-400 mb-4">Risk Treatment & Controls</h3>
            
            <div class="mb-4">
                <div class="flex items-center">
                    <label for="riskTreatmentSelect" class="block text-sm font-medium text-gray-300 mb-1 mr-2">Select Risk Treatment</label>
                    <span id="treatmentInfo" class="info-icon text-xs text-gray-400 border border-gray-500 rounded-full w-4 h-4 flex items-center justify-center mb-1 flex-shrink-0" title="Mitigate: Apply controls. Accept: Take no action. Transfer: Move risk to a third party (e.g., insurance). Avoid: Stop the risky activity.">?</span>
                </div>
                <select id="riskTreatmentSelect" class="w-full bg-gray-700 border-gray-600 rounded-md p-2">
                    <option value="mitigate">Mitigate</option>
                    <option value="accept">Accept</option>
                    <option value="transfer">Transfer</option>
                    <option value="avoid">Avoid</option>
                </select>
            </div>

            <div id="riskJustificationContainer" class="mb-4 hidden">
                <label for="riskJustification" class="block text-sm font-medium text-gray-300 mb-1">Justification</label>
                <textarea id="riskJustification" rows="2" class="w-full bg-gray-700 border-gray-600 rounded-md p-2" placeholder="Explain why this risk is being accepted, transferred, or avoided."></textarea>
            </div>

            <div id="controlsContainer">
                <div id="recommendedControls" class="mb-6"><h4 class="font-semibold text-gray-200 mb-2">Recommended Controls</h4><div id="recommendedControlsList" class="space-y-2"></div></div>
                <div class="border-t border-gray-600 pt-4"><h4 class="font-semibold text-gray-200 mb-2">Browse All Controls</h4><div id="allControlsList" class="max-h-[250px] overflow-y-auto space-y-2 pr-2"></div></div>
            </div>

            <div class="mt-6 flex justify-end space-x-4"><button id="cancelControlsBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500">Cancel</button><button id="saveControlsBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700">Save</button></div>
        </div>
    </div>
    
    <div id="importModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="modal-content bg-gray-800 w-full max-w-lg rounded-lg shadow-xl p-6 transform -translate-y-10 border border-gray-600">
            <h3 class="text-xl font-bold text-green-400 mb-4">Import Risks from CSV</h3>
            <div class="bg-gray-900/50 border border-yellow-700 rounded-lg p-4 mb-6">
                <h4 class="font-bold text-yellow-400 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.21 2.863-1.21 3.5 0l5.884 11.232c.636 1.21-.482 2.669-1.75 2.669H4.123c-1.268 0-2.386-1.458-1.75-2.669L8.257 3.099zM9 13a1 1 0 112 0v2a1 1 0 11-2 0v-2zm1-4a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>Important Notice</h4>
                <p class="text-sm text-gray-400 mt-2">This will <strong class="text-gray-300">merge</strong> the risks from your CSV file with your current session.</p>
                <ul class="text-sm text-gray-400 mt-2 list-disc list-inside space-y-1">
                    <li>Risk IDs from the file will be ignored and new ones assigned.</li>
                    <li>If an asset in the CSV doesn't exist, it will be created automatically.</li>
                    <li><strong class="text-yellow-400">Duplicate risks will be skipped.</strong> A duplicate is a risk with the same Asset, Description, Treatment, and Justification.</li>
                </ul>
            </div>
            <div class="mt-6 flex justify-end space-x-4"><button id="cancelImportBtn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-500">Cancel</button><button id="confirmImportBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Choose File & Import</button></div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guideModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="modal-content bg-gray-800 w-full max-w-2xl rounded-lg shadow-xl p-6 transform -translate-y-10 border border-gray-600 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold text-purple-400 mb-4">A Quick Guide to GRC and ISO 27001 for NGOs</h3>
            
            <div class="text-gray-300 space-y-4">
                <div>
                    <h4 class="font-semibold text-lg text-sky-400">What is GRC? (Governance, Risk, and Compliance)</h4>
                    <p>GRC is a structured way of managing an organization. For an NGO, it means:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1 pl-2">
                        <li><strong>Governance:</strong> How you make decisions and direct your organization to achieve its mission ethically and effectively.</li>
                        <li><strong>Risk Management:</strong> Identifying, assessing, and treating potential threats to your mission, data, and beneficiaries. This is the core focus of this tool.</li>
                        <li><strong>Compliance:</strong> Following the laws, regulations, and standards that apply to your work (like GDPR for data protection).</li>
                    </ul>
                </div>

                <div>
                    <h4 class="font-semibold text-lg text-sky-400">What is ISO 27001?</h4>
                    <p>ISO 27001 is the leading international standard for an <strong class="text-white">Information Security Management System (ISMS)</strong>. It’s a framework of policies and procedures that helps organizations manage and protect their information assets. It's not just about IT; it's about managing people, processes, and technology to keep data secure.</p>
                     <p class="mt-2">For an NGO, this is crucial. You handle sensitive data about beneficiaries, donors, and staff. A data breach could not only cause harm to these individuals but also damage your reputation and ability to operate.</p>
                </div>

                <div>
                    <h4 class="font-semibold text-lg text-sky-400">How This Tool Helps Your NGO</h4>
                    <p>This toolkit guides you through the most critical parts of ISO 27001 risk management without the complexity. It helps you build two key documents:</p>
                    <ol class="list-decimal list-inside mt-2 space-y-2 pl-2">
                        <li>
                            <strong class="text-white">ISO 27001 Risk Register (Step 2):</strong>
                            <ul class="list-disc list-inside mt-1 pl-4 text-gray-400">
                                <li><strong>Identify Assets:</strong> What valuable information and systems do you have (e.g., beneficiary database, laptops)?</li>
                                <li><strong>Define Risks:</strong> What bad things could happen to those assets (e.g., data breach, theft)?</li>
                                <li><strong>Treat Risks:</strong> Decide how to handle each risk and select appropriate security controls from the ISO 27001 Annex A list.</li>
                            </ul>
                        </li>
                        <li>
                            <strong class="text-white">Data Protection Impact Assessment (DPIA) (Step 3):</strong>
                            <p class="text-gray-400 mt-1">A simple version of a DPIA required by regulations like GDPR. It helps you think through the privacy implications of how you handle personal data, ensuring you are processing it lawfully and safely.</p>
                        </li>
                    </ol>
                </div>
                 <p class="mt-4 pt-4 border-t border-gray-700">By using this tool, you take a proactive step towards protecting your organization's most critical data, building trust with your stakeholders, and ensuring the continuity of your mission.</p>
            </div>

            <div class="mt-6 flex justify-end">
                <button id="closeGuideBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700">Close</button>
            </div>
        </div>
    </div>


    <script>
    /**
     * NGO GRC Toolkit
     * Author: Mathias Hagstrøm <maheha@gmail.com>
     * License: GPL-3.0 - See the full license text at the top of this file.
     */
    document.addEventListener('DOMContentLoaded', () => {

        // --- DATA & STATE MANAGEMENT --- //
        // This is the single source of truth for the entire application.
        // Everything the user inputs is stored here.
        const AppState = {
            currentStep: 1,
            totalSteps: 4,
            riskCounter: 1, // Simple counter for unique risk IDs (e.g., RISK-001)
            currentRiskIdForModal: null, // Tracks which risk we're editing in the modal
            data: {
                ngoName: '',
                ngoMission: '',
                assets: [],
                risks: [],
                dpia: { q1: '', q2: '', q3: '', q4: '' }
            },
            hasUnsavedChanges: false // Flag to warn user before they leave with unsaved data
        };

        // The complete list of ISO 27001:2022 Annex A controls.
        // This is static data used to populate the control selection modal.
        const ISO_CONTROLS = [
            // A.5 Organizational Controls (37 controls)
            { id: 'A.5.1', name: 'Policies for information security', description: 'Define and approve a set of policies for information security management.' },
            { id: 'A.5.2', name: 'Information security roles and responsibilities', description: 'Define and allocate information security roles and responsibilities.' },
            { id: 'A.5.3', name: 'Segregation of duties', description: 'Ensure that conflicting duties and areas of responsibility are segregated.' },
            { id: 'A.5.4', name: 'Management responsibilities', description: 'Ensure management requires all personnel to apply information security in accordance with the established policies.' },
            { id: 'A.5.5', name: 'Contact with authorities', description: 'Maintain appropriate contact with relevant authorities.' },
            { id: 'A.5.6', name: 'Contact with special interest groups', description: 'Maintain appropriate contact with special interest groups or other specialist security forums and professional associations.' },
            { id: 'A.5.7', name: 'Threat intelligence', description: 'Collect and analyze information relating to information security threats.' },
            { id: 'A.5.8', name: 'Information security in project management', description: 'Integrate information security into project management.' },
            { id: 'A.5.9', name: 'Inventory of information and other associated assets', description: 'Develop and maintain an inventory of information and other associated assets.' },
            { id: 'A.5.10', name: 'Acceptable use of information and other associated assets', description: 'Define and implement rules for the acceptable use of information and associated assets.' },
            { id: 'A.5.11', name: 'Return of assets', description: 'Ensure personnel and other interested parties return all of the organization\'s assets in their possession upon termination of their employment, contract or agreement.' },
            { id: 'A.5.12', name: 'Classification of information', description: 'Classify information in terms of legal requirements, value, criticality and sensitivity to unauthorized disclosure or modification.' },
            { id: 'A.5.13', name: 'Labelling of information', description: 'Develop and implement a set of procedures for information labelling.' },
            { id: 'A.5.14', name: 'Information transfer', description: 'Establish and enforce information transfer rules, procedures, or agreements.' },
            { id: 'A.5.15', name: 'Access control', description: 'Establish and implement rules to control physical and logical access to information and other associated assets.' },
            { id: 'A.5.16', name: 'Identity management', description: 'Manage the full lifecycle of identities.' },
            { id: 'A.5.17', name: 'Authentication information', description: 'Manage the allocation and use of authentication information.' },
            { id: 'A.5.18', name: 'Access rights', description: 'Specify and manage access rights to information and other associated assets.' },
            { id: 'A.5.19', name: 'Information security in supplier relationships', description: 'Define and manage information security for the use of supplier products or services.' },
            { id: 'A.5.20', name: 'Addressing information security within supplier agreements', description: 'Establish agreed-upon information security requirements in supplier agreements.' },
            { id: 'A.5.21', name: 'Managing information security in the information and communication technology (ICT) supply chain', description: 'Manage security risks in the ICT supply chain.' },
            { id: 'A.5.22', name: 'Monitoring, review and change management of supplier services', description: 'Regularly monitor, review, and manage changes in supplier services.' },
            { id: 'A.5.23', name: 'Information security for use of cloud services', description: 'Establish processes for the acquisition, use, management, and exit from cloud services.' },
            { id: 'A.5.24', name: 'Information security incident management planning and preparation', description: 'Plan and prepare for managing information security incidents.' },
            { id: 'A.5.25', name: 'Assessment and decision on information security events', description: 'Assess information security events and decide if they are to be categorized as incidents.' },
            { id: 'A.5.26', name: 'Response to information security incidents', description: 'Respond to information security incidents in accordance with documented procedures.' },
            { id: 'A.5.27', name: 'Learning from information security incidents', description: 'Use the knowledge gained from information security incidents to strengthen and improve controls.' },
            { id: 'A.5.28', name: 'Collection of evidence', description: 'Establish and implement procedures for the identification, collection, acquisition, and preservation of evidence related to information security events.' },
            { id: 'A.5.29', name: 'Information security during disruption', description: 'Plan how to maintain information security at an appropriate level during disruption.' },
            { id: 'A.5.30', name: 'ICT readiness for business continuity', description: 'Ensure ICT readiness is planned, implemented, maintained, and tested based on business continuity objectives.' },
            { id: 'A.5.31', name: 'Identification of legal, statutory, regulatory and contractual requirements', description: 'Identify and document all relevant legal, statutory, regulatory, and contractual requirements.' },
            { id: 'A.5.32', name: 'Intellectual property rights', description: 'Implement procedures to protect intellectual property rights.' },
            { id: 'A.5.33', name: 'Protection of records', description: 'Protect records from loss, destruction, falsification, unauthorized access, and unauthorized release.' },
            { id: 'A.5.34', name: 'Privacy and protection of personally identifiable information (PII)', description: 'Identify and meet the requirements regarding the preservation of privacy and protection of PII.' },
            { id: 'A.5.35', name: 'Independent review of information security', description: 'Ensure an independent review of the organization\'s information security practices.' },
            { id: 'A.5.36', name: 'Compliance with policies, rules and standards for information security', description: 'Ensure compliance with the organization\'s information security policies, rules, and standards.' },
            { id: 'A.5.37', name: 'Documented operating procedures', description: 'Ensure that information processing facilities are managed through documented operating procedures.' },
            
            // A.6 People Controls (8 controls)
            { id: 'A.6.1', name: 'Screening', description: 'Conduct background verification checks on all candidates for employment in accordance with relevant laws and ethics.' },
            { id: 'A.6.2', name: 'Terms and conditions of employment', description: 'Ensure employment agreements state personnel\'s responsibilities for information security.' },
            { id: 'A.6.3', name: 'Information security awareness, education and training', description: 'Provide personnel with appropriate information security awareness, education, and training.' },
            { id: 'A.6.4', name: 'Disciplinary process', description: 'Establish a formal disciplinary process for personnel who have committed an information security violation.' },
            { id: 'A.6.5', name: 'Responsibilities after termination or change of employment', description: 'Manage responsibilities and access rights after termination or change of employment.' },
            { id: 'A.6.6', name: 'Confidentiality or non-disclosure agreements', description: 'Use confidentiality or non-disclosure agreements to reflect the organization\'s needs for the protection of information.' },
            { id: 'A.6.7', name: 'Remote working', description: 'Implement security measures for personnel working remotely.' },
            { id: 'A.6.8', name: 'Information security event reporting', description: 'Provide a mechanism for personnel to report observed or suspected information security events.' },

            // A.7 Physical Controls (14 controls)
            { id: 'A.7.1', name: 'Physical security perimeters', description: 'Define and use security perimeters to protect areas that contain sensitive or critical information and assets.' },
            { id: 'A.7.2', name: 'Physical entry', description: 'Secure areas shall be protected by appropriate entry controls.' },
            { id: 'A.7.3', name: 'Securing offices, rooms and facilities', description: 'Design and apply procedures for physical security in offices, rooms, and facilities.' },
            { id: 'A.7.4', name: 'Physical security monitoring', description: 'Monitor premises continuously for unauthorized physical access.' },
            { id: 'A.7.5', name: 'Protecting against physical and environmental threats', description: 'Design and apply physical protection against natural disasters, malicious attack, or accidents.' },
            { id: 'A.7.6', name: 'Working in secure areas', description: 'Design and apply procedures for working in secure areas.' },
            { id: 'A.7.7', name: 'Clear desk and clear screen', description: 'Establish and enforce clear desk and clear screen policies.' },
            { id: 'A.7.8', name: 'Equipment siting and protection', description: 'Position and protect equipment to reduce risks from environmental threats and unauthorized access.' },
            { id: 'A.7.9', name: 'Security of assets off-premises', description: 'Implement security measures for assets outside the organization’s premises.' },
            { id: 'A.7.10', name: 'Storage media', description: 'Manage storage media throughout its lifecycle of procurement, use, transport, and disposal.' },
            { id: 'A.7.11', name: 'Supporting utilities', description: 'Protect information processing facilities from power failures and other disruptions caused by failures in supporting utilities.' },
            { id: 'A.7.12', name: 'Cabling security', description: 'Protect power and telecommunications cabling from interception, interference or damage.' },
            { id: 'A.7.13', name: 'Equipment maintenance', description: 'Perform equipment maintenance correctly to ensure continued availability and integrity.' },
            { id: 'A.7.14', name: 'Secure disposal or re-use of equipment', description: 'Verify that all sensitive data and licensed software has been removed or securely overwritten prior to equipment disposal or re-use.' },

            // A.8 Technological Controls (34 controls)
            { id: 'A.8.1', name: 'User endpoint devices', description: 'Protect user endpoint devices.' },
            { id: 'A.8.2', name: 'Privileged access rights', description: 'Restrict and manage the allocation and use of privileged access rights.' },
            { id: 'A.8.3', name: 'Information access restriction', description: 'Manage access to information and application system functions according to the access control policy.' },
            { id: 'A.8.4', name: 'Access to source code', description: 'Securely manage access to source code.' },
            { id: 'A.8.5', name: 'Secure authentication', description: 'Ensure secure authentication of users to access systems and services.' },
            { id: 'A.8.6', name: 'Capacity management', description: 'Monitor, use, and make projections of capacity demands.' },
            { id: 'A.8.7', name: 'Protection against malware', description: 'Implement protection against malware.' },
            { id: 'A.8.8', name: 'Management of technical vulnerabilities', description: 'Identify and manage technical vulnerabilities in a timely manner.' },
            { id: 'A.8.9', name: 'Configuration management', description: 'Establish and maintain secure configurations of hardware, software, services, and networks.' },
            { id: 'A.8.10', name: 'Information deletion', description: 'Use tools to erase information stored in information systems, devices or in any other storage media when it is no longer required.' },
            { id: 'A.8.11', name: 'Data masking', description: 'Use data masking in accordance with the organization\'s access control policy and other related topic policies.' },
            { id: 'A.8.12', name: 'Data leakage prevention', description: 'Apply data leakage prevention measures to systems, networks, and devices that process, store, or transmit sensitive information.' },
            { id: 'A.8.13', name: 'Information backup', description: 'Create and maintain regular backups of information, software, and systems.' },
            { id: 'A.8.14', name: 'Redundancy of information processing facilities', description: 'Ensure sufficient redundancy in information processing facilities to meet availability requirements.' },
            { id: 'A.8.15', name: 'Logging', description: 'Produce, store, protect, and analyze logs of events.' },
            { id: 'A.8.16', name: 'Monitoring activities', description: 'Monitor networks, systems, and applications for anomalous behavior.' },
            { id: 'A.8.17', name: 'Clock synchronization', description: 'Synchronize the clocks of all relevant information processing systems.' },
            { id: 'A.8.18', name: 'Use of privileged utility programs', description: 'Restrict the use of utility programs that can override system and application controls.' },
            { id: 'A.8.19', name: 'Installation of software on operational systems', description: 'Establish and implement procedures to securely manage software installation on operational systems.' },
            { id: 'A.8.20', name: 'Networks security', description: 'Securely manage and control networks.' },
            { id: 'A.8.21', name: 'Security of network services', description: 'Identify and implement security mechanisms for network services.' },
            { id: 'A.8.22', name: 'Segregation of networks', description: 'Segregate groups of information services, users, and information systems on networks.' },
            { id: 'A.8.23', name: 'Web filtering', description: 'Manage access to external websites to prevent exposure to malicious content.' },
            { id: 'A.8.24', name: 'Use of cryptography', description: 'Define and implement a policy on the use of cryptographic controls.' },
            { id: 'A.8.25', name: 'Secure development life cycle', description: 'Establish and apply rules for the secure development of software and systems.' },
            { id: 'A.8.26', name: 'Application security requirements', description: 'Specify, document, and approve information security requirements for new applications or enhancements.' },
            { id: 'A.8.27', name: 'Secure system architecture and engineering principles', description: 'Establish, document, maintain and apply secure system engineering principles.' },
            { id: 'A.8.28', name: 'Secure coding', description: 'Apply secure coding principles to software development.' },
            { id: 'A.8.29', name: 'Security testing in development and acceptance', description: 'Perform security testing throughout the development lifecycle.' },
            { id: 'A.8.30', name: 'Outsourced development', description: 'Supervise and monitor the activity of outsourced system development.' },
            { id: 'A.8.31', name: 'Separation of development, testing and production environments', description: 'Separate development, testing, and production environments.' },
            { id: 'A.8.32', name: 'Change management', description: 'Manage changes to information processing facilities and systems.' },
            { id: 'A.8.33', name: 'Test information', description: 'Carefully select and protect information used for testing.' },
            { id: 'A.8.34', name: 'Protection of information systems during audit testing', description: 'Plan and agree on audit tests to minimize impact on operational systems.' },
        ];
        
        // This is a simplified logic map to suggest relevant controls.
        // It connects threat/vulnerability pairs and asset types to a few example controls.
        // A more advanced version could be much more detailed.
        const CONTROL_LOGIC_MAP = {
            'malicious-technical': ['A.8.2', 'A.8.16', 'A.8.23', 'A.8.9'], 'malicious-human': ['A.6.3', 'A.8.2', 'A.8.12', 'A.6.4'], 'malicious-physical': ['A.7.1', 'A.7.2', 'A.7.4', 'A.7.6'], 'accidental-human': ['A.6.3', 'A.5.1', 'A.7.7', 'A.5.14'], 'accidental-technical': ['A.8.9', 'A.8.16'], 'technical-technical': ['A.8.9', 'A.8.28'], 'default-data': ['A.5.9', 'A.8.3', 'A.8.12', 'A.5.14'], 'default-hardware': ['A.5.9', 'A.7.6', 'A.8.1'], 'default-facility': ['A.7.1', 'A.7.2', 'A.7.4'], 'default-people': ['A.6.3', 'A.6.4'], 'default-software': ['A.8.28', 'A.8.9']
        };

        // Calculates a risk level and color based on a simple impact * likelihood matrix.
        const getRiskLevel = (impact, likelihood) => {
            const score = impact * likelihood;
            if (score >= 15) return { level: 'Critical', color: 'text-red-400' };
            if (score >= 9) return { level: 'High', color: 'text-orange-400' };
            if (score >= 5) return { level: 'Medium', color: 'text-yellow-400' };
            return { level: 'Low', color: 'text-green-400' };
        };

        // Looks up recommended controls based on the risk's properties.
        const getRecommendedControls = (risk) => {
            const asset = AppState.data.assets.find(a => a.id === risk.assetId);
            if (!asset) return [];
            const key = `${risk.threatCat}-${risk.vulnCat}`;
            const defaultKey = `default-${asset.category}`;
            const recommendedIds = new Set([...(CONTROL_LOGIC_MAP[key] || []), ...(CONTROL_LOGIC_MAP[defaultKey] || [])]);
            return Array.from(recommendedIds);
        };
        
        // --- UI VIEW MODULE --- //
        // This object handles all direct manipulation of the DOM.
        // It's responsible for rendering data, showing/hiding elements, and displaying modals.
        const UIView = {
            // Store references to frequently used DOM elements to avoid repeated lookups.
            elements: {
                progressBar: document.getElementById('progressBar'),
                stepIndicator: document.getElementById('stepIndicator'),
                prevBtn: document.getElementById('prevBtn'),
                nextBtn: document.getElementById('nextBtn'),
                steps: document.querySelectorAll('.step-container'),
                controlModal: document.getElementById('controlSelectionModal'),
                importModal: document.getElementById('importModal'),
                guideModal: document.getElementById('guideModal'),
                assetList: document.getElementById('assetList'),
                riskTableContainer: document.getElementById('riskRegisterTableContainer'),
                dpiaReview: document.getElementById('dpiaReview'),
                riskReviewContainer: document.getElementById('riskRegisterReview'),
                riskTreatmentSelect: document.getElementById('riskTreatmentSelect'),
                riskJustificationContainer: document.getElementById('riskJustificationContainer'),
                controlsContainer: document.getElementById('controlsContainer'),
            },

            // Shows a short-lived notification message (a "toast") at the top right of the screen.
            showToast(message, type = 'success', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                // Trigger the slide-in animation.
                setTimeout(() => toast.classList.add('show'), 10);
                // Set a timer to remove the toast after the specified duration.
                setTimeout(() => {
                    toast.classList.remove('show');
                    // Wait for the slide-out animation to finish before removing from the DOM.
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            },
            
            // Updates the progress bar and step indicator text.
            updateNavigation() {
                const { currentStep, totalSteps } = AppState;
                this.elements.progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
                this.elements.stepIndicator.textContent = `Step ${currentStep} of ${totalSteps}`;
                // Show the current step, hide the others.
                this.elements.steps.forEach(step => step.classList.remove('active'));
                document.getElementById(`step-${currentStep}`).classList.add('active');
                // Disable 'Previous' button on the first step.
                this.elements.prevBtn.disabled = currentStep === 1;
                this.elements.nextBtn.textContent = currentStep === totalSteps ? 'Finish' : 'Next';
            },

            // Renders the list of assets in Step 2 from the AppState.
            renderAssetList() {
                this.elements.assetList.innerHTML = ''; // Clear the list first
                AppState.data.assets.forEach(asset => {
                    const div = document.createElement('div');
                    div.className = 'list-item p-2 cursor-pointer rounded-md flex justify-between items-center';
                    div.dataset.id = asset.id;

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${asset.name} `;
                    const categorySpan = document.createElement('span');
                    categorySpan.className = 'text-xs text-gray-400';
                    categorySpan.textContent = `(${asset.category})`;
                    nameSpan.appendChild(categorySpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '×';
                    deleteBtn.className = 'text-red-400 hover:text-red-300 font-bold';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); EventHandlers.handleDeleteAsset(asset.id, asset.name); };
                    
                    div.appendChild(nameSpan);
                    div.appendChild(deleteBtn);
                    div.onclick = () => EventHandlers.handleSelectAsset(asset.id, asset.name);
                    this.elements.assetList.appendChild(div);
                });
            },

            // Renders the main risk table in Step 2.
            // Accepts an optional array of risk IDs to highlight (used by the duplicate finder).
            renderRiskTable(highlightedRiskIds = []) {
                const container = this.elements.riskTableContainer;
                container.innerHTML = '';
                if (AppState.data.risks.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No risks added yet.</p>';
                    return;
                }
                
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left';
                table.innerHTML = `<thead class="bg-gray-700 text-gray-300"><tr><th class="p-2">ID</th><th class="p-2">Asset</th><th class="p-2">Risk</th><th class="p-2">Level</th><th class="p-2">Treatment</th><th class="p-2">Action</th></tr></thead>`;
                const tbody = document.createElement('tbody');

                AppState.data.risks.forEach(risk => {
                    const asset = AppState.data.assets.find(a => a.id === risk.assetId);
                    const { level, color } = getRiskLevel(risk.impact, risk.likelihood);
                    const row = tbody.insertRow();
                    row.className = 'border-b border-gray-700';

                    // If this risk ID is in the highlighted list, add a special class.
                    if (highlightedRiskIds.includes(risk.id)) {
                        row.className += ' bg-yellow-900/50';
                    }
                    const isDuplicate = highlightedRiskIds.includes(risk.id);
                    const duplicateBadge = isDuplicate ? '<span class="text-yellow-400 font-bold text-xs ml-1">[DUPLICATE]</span>' : '';

                    row.innerHTML = `
                        <td class="p-2 font-mono text-xs">${risk.riskId} ${duplicateBadge}</td>
                        <td class="p-2">${asset ? asset.name : 'N/A'}</td>
                        <td class="p-2">${risk.description}</td>
                        <td class="p-2 font-semibold ${color}">${level}</td>
                        <td class="p-2 capitalize">${risk.treatment}</td>`;

                    const actionCell = row.insertCell();
                    actionCell.className = 'p-2';
                    const editBtn = document.createElement('button');
                    editBtn.className = 'text-sky-400 hover:text-sky-300 mr-2';
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = () => this.openControlModal(risk.id);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-400 hover:text-red-300';
                    deleteBtn.textContent = 'Del';
                    deleteBtn.onclick = () => EventHandlers.handleDeleteRisk(risk.id);
                    
                    actionCell.append(editBtn, deleteBtn);
                });
                table.append(tbody);
                container.appendChild(table);
            },

            // Populates the read-only summary data in the final "Review" step.
            populateReviewData() {
                // A simple santizer to prevent any HTML injection in the review text.
                const sanitize = (text) => text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
                this.elements.dpiaReview.innerHTML = `
                    <p><strong>1. Nature of Processing:</strong><br>${sanitize(AppState.data.dpia.q1) || '<em>Not provided</em>'}</p>
                    <p><strong>2. Necessity & Proportionality:</strong><br>${sanitize(AppState.data.dpia.q2) || '<em>Not provided</em>'}</p>
                    <p><strong>3. Risks to Individuals:</strong><br>${sanitize(AppState.data.dpia.q3) || '<em>Not provided</em>'}</p>
                    <p><strong>4. Mitigation Measures:</strong><br>${sanitize(AppState.data.dpia.q4) || '<em>Not provided</em>'}</p>`;
                
                const container = this.elements.riskReviewContainer;
                container.innerHTML = '';
                if (AppState.data.risks.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No risks were added.</p>'; return;
                }
                const table = document.createElement('table');
                table.className = 'w-full text-sm text-left';
                table.innerHTML = `<thead class="bg-gray-700 text-gray-300"><tr><th class="p-2">ID</th><th class="p-2">Asset</th><th class="p-2">Risk</th><th class="p-2">Level</th><th class="p-2">Treatment</th><th class="p-2">Controls</th></tr></thead>`;
                const tbody = document.createElement('tbody');
                AppState.data.risks.forEach(risk => {
                    const asset = AppState.data.assets.find(a => a.id === risk.assetId);
                    const { level, color } = getRiskLevel(risk.impact, risk.likelihood);
                    const controlsText = risk.controls.length > 0 ? risk.controls.join(', ') : 'None';
                    const row = tbody.insertRow();
                    row.className = 'border-b border-gray-700';
                    row.innerHTML = `
                        <td class="p-2 font-mono text-xs">${risk.riskId}</td>
                        <td class="p-2">${asset ? sanitize(asset.name) : 'N/A'}</td>
                        <td class="p-2">${sanitize(risk.description)}</td>
                        <td class="p-2 font-semibold ${color}">${level}</td>
                        <td class="p-2 capitalize">${risk.treatment}</td>
                        <td class="p-2">${controlsText}</td>`;
                });
                table.appendChild(tbody);
                container.appendChild(table);
            },
            
            // Generic function to toggle the visibility of any modal.
            toggleModal(modalElement, show) {
                if (show) {
                    modalElement.classList.remove('opacity-0', 'pointer-events-none');
                } else {
                    modalElement.classList.add('opacity-0', 'pointer-events-none');
                }
            },

            // Opens the "Select Controls" modal and populates it with data for the given risk.
            openControlModal(riskId) {
                AppState.currentRiskIdForModal = riskId;
                const risk = AppState.data.risks.find(r => r.id === riskId);
                if (!risk) return;

                // Pre-fill the form with the risk's current treatment and justification.
                this.elements.riskTreatmentSelect.value = risk.treatment;
                document.getElementById('riskJustification').value = risk.justification;
                this.updateTreatmentUI(risk.treatment);
                
                const recommendedIds = getRecommendedControls(risk);
                
                // Helper function to create a single checkbox item for a control.
                const renderControlCheckbox = (control, isRecommended) => {
                    const isChecked = risk.controls.includes(control.id);
                    
                    const label = document.createElement('label');
                    label.className = `flex items-center p-2 rounded-md hover:bg-gray-700 cursor-pointer ${isRecommended ? 'border border-sky-500' : ''}`;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox'; checkbox.value = control.id; checkbox.checked = isChecked;
                    checkbox.className = 'form-checkbox h-4 w-4 bg-gray-600 border-gray-500 rounded text-sky-500 focus:ring-sky-600';

                    const textContainer = document.createElement('span');
                    textContainer.className = 'ml-3 text-sm';
                    textContainer.innerHTML = `<strong class="text-sky-400">${control.id} - ${control.name} </strong><span class="info-icon text-gray-400 ml-1" title="${control.description}">(?)</span>`;
                    
                    label.append(checkbox, textContainer);
                    return label;
                };

                const recommendedList = document.getElementById('recommendedControlsList');
                const allControlsList = document.getElementById('allControlsList');
                recommendedList.innerHTML = ''; allControlsList.innerHTML = '';

                ISO_CONTROLS.forEach(control => {
                    const isRecommended = recommendedIds.includes(control.id);
                    const checkbox = renderControlCheckbox(control, isRecommended);
                    if (isRecommended) {
                        recommendedList.appendChild(checkbox);
                    }
                    // Every control also goes into the "All Controls" list.
                    allControlsList.appendChild(checkbox.cloneNode(true));
                });
                
                this.toggleModal(this.elements.controlModal, true);
            },
            
            // Shows/hides the justification box based on the selected risk treatment.
            updateTreatmentUI(treatment) {
                const showJustification = (treatment !== 'mitigate');
                this.elements.riskJustificationContainer.classList.toggle('hidden', !showJustification);
                this.elements.controlsContainer.classList.toggle('hidden', showJustification);
            },
            
            // Reloads all user-editable data from AppState into the UI.
            // Useful after loading a session from a file.
            refreshAllUI() {
                const { ngoName, ngoMission, dpia } = AppState.data;
                document.getElementById('ngoName').value = ngoName;
                document.getElementById('ngoMission').value = ngoMission;
                document.getElementById('dpiaQ1').value = dpia.q1 || '';
                document.getElementById('dpiaQ2').value = dpia.q2 || '';
                document.getElementById('dpiaQ3').value = dpia.q3 || '';
                document.getElementById('dpiaQ4').value = dpia.q4 || '';
                this.renderAssetList();
                this.renderRiskTable();
                AppState.currentStep = 1; // Go back to the first step for clarity
                this.updateNavigation();
                if (AppState.currentStep === 4) { this.populateReviewData(); }
            }
        };

        // --- DATA SERVICE MODULE --- //
        // This object handles all data import/export logic, like saving and loading files.
        const DataService = {
            // Generates a standardized filename based on NGO name and current timestamp.
            generateFilenameBase() {
                const ngoName = (AppState.data.ngoName.trim() || 'NGO').replace(/\s+/g, '-');
                const timestamp = new Date().toISOString().slice(0, 16).replace('T', '_').replace(':', 'h') + 'm';
                return `${ngoName}-GRC-${timestamp}`;
            },

            // Finds risks that have the same asset and description.
            findDuplicates() {
                const duplicates = new Set();
                const riskSignatures = new Map();

                AppState.data.risks.forEach(risk => {
                    const asset = AppState.data.assets.find(a => a.id === risk.assetId);
                    if (!asset) return; // Skip if asset is somehow missing
                    
                    // A "signature" is a unique identifier for a risk's content.
                    // Here, it's the asset name + risk description, normalized to lowercase.
                    const signature = `${asset.name.toLowerCase().trim()}|${risk.description.toLowerCase().trim()}`;

                    if (riskSignatures.has(signature)) {
                        // We've seen this signature before! It's a duplicate.
                        // Add both the current risk and the previously seen one to our set.
                        duplicates.add(risk.id);
                        duplicates.add(riskSignatures.get(signature));
                    } else {
                        // First time seeing this signature, so we'll store it.
                        riskSignatures.set(signature, risk.id);
                    }
                });

                return Array.from(duplicates); // Convert Set to Array
            },
            
            // Saves the entire AppState.data object to a JSON file.
            saveSession() {
                const sessionData = JSON.stringify(AppState.data, null, 2);
                const blob = new Blob([sessionData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${DataService.generateFilenameBase()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                UIView.showToast('Session saved successfully!');
                AppState.hasUnsavedChanges = false;
            },

            // Loads a session from a user-selected JSON file.
            loadSession(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loadedData = JSON.parse(e.target.result);
                        // Basic validation to make sure it looks like our data structure.
                        if (typeof loadedData.ngoName === 'string' && Array.isArray(loadedData.assets)) {
                            AppState.data = { ...AppState.data, ...loadedData };
                            
                            // Ensure dpia and risk properties exist to avoid errors with older session files.
                            AppState.data.dpia = { q1: '', q2: '', q3: '', q4: '', ...AppState.data.dpia };
                            AppState.data.risks.forEach(risk => {
                                if (!risk.treatment) risk.treatment = 'mitigate';
                                if (!risk.justification) risk.justification = '';
                            });

                            // Recalculate the next risk ID to avoid duplicates.
                            if (AppState.data.risks.length > 0) {
                                const maxId = Math.max(0, ...AppState.data.risks.map(r => parseInt((r.riskId || 'RISK-000').split('-')[1])));
                                AppState.riskCounter = maxId + 1;
                            } else {
                                AppState.riskCounter = 1;
                            }
                            UIView.refreshAllUI();
                            UIView.showToast('Progress loaded successfully!');
                            AppState.hasUnsavedChanges = false;
                        } else { throw new Error('Invalid file structure.'); }
                    } catch (error) {
                        console.error("Failed to load session:", error);
                        UIView.showToast('Error: Invalid session file.', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Reset file input to allow loading the same file again.
            },

            // Imports risks from a CSV file.
            importFromCsv(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const lines = e.target.result.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length < 2) throw new Error("CSV has no data rows.");
                        
                        const headers = lines.shift().split(',').map(h => h.trim().replace(/"/g, ''));
                        let importedCount = 0; let skippedCount = 0;
                        
                        lines.forEach(line => {
                            // Regex to handle CSVs that might have quoted fields containing commas.
                            const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(v => v.replace(/"/g, ''));
                            const rowData = headers.reduce((obj, header, index) => { obj[header] = values[index]; return obj; }, {});
                            
                            const assetName = rowData["Asset"]?.trim();
                            const riskDescription = rowData["Risk Description"]?.trim();
                            if (!assetName || !riskDescription) return; // Skip empty rows.

                            // Simple check to prevent importing exact duplicates from the CSV.
                            const isDuplicate = AppState.data.risks.some(r => {
                                const asset = AppState.data.assets.find(a => a.id === r.assetId);
                                return asset && asset.name === assetName && r.description === riskDescription;
                            });

                            if (isDuplicate) { skippedCount++; return; }

                            // If asset from CSV doesn't exist, create it. Otherwise, use the existing one.
                            let asset = AppState.data.assets.find(a => a.name === assetName);
                            if (!asset) {
                                asset = { id: crypto.randomUUID(), name: assetName, category: 'data' };
                                AppState.data.assets.push(asset);
                            }

                            const newRisk = {
                                id: crypto.randomUUID(),
                                riskId: `RISK-${String(AppState.riskCounter++).padStart(3, '0')}`,
                                assetId: asset.id,
                                description: riskDescription,
                                impact: parseInt(rowData["Impact"]) || 3,
                                likelihood: parseInt(rowData["Likelihood"]) || 3,
                                threatCat: 'malicious', // Default values since these are not in the CSV
                                vulnCat: 'technical',  // Default values
                                treatment: (rowData["Treatment"] || 'mitigate').toLowerCase().trim(),
                                justification: rowData["Justification"]?.trim() || '',
                                controls: (rowData["Selected Controls"] || '').split(';').map(c => c.trim()).filter(Boolean)
                            };
                            AppState.data.risks.push(newRisk);
                            importedCount++;
                        });
                        
                        let message = `Successfully imported ${importedCount} new risks.`;
                        if (skippedCount > 0) message += ` Skipped ${skippedCount} duplicate risks.`;
                        UIView.showToast(message, 'success', 5000);
                        UIView.refreshAllUI();
                        AppState.hasUnsavedChanges = true;
                    } catch (error) {
                        console.error("Failed to process CSV:", error);
                        UIView.showToast(`Error processing CSV: ${error.message}`, 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = null; // Reset file input
                UIView.toggleModal(UIView.elements.importModal, false);
            },
            
            // Generates and downloads a PDF report.
            downloadPdf() {
                const { jsPDF } = window.jspdf; 
                const doc = new jsPDF();
                const { ngoName, ngoMission, dpia, risks, assets } = AppState.data;
                
                // Page 1: Title and DPIA
                doc.setFontSize(18); doc.text(ngoName || 'NGO GRC Report', 14, 22);
                doc.setFontSize(11); doc.setTextColor(100); doc.text(`Mission: ${ngoMission || 'N/A'}`, 14, 30);
                doc.setFontSize(14); doc.setTextColor(0); doc.text('Data Protection Impact Assessment (DPIA)', 14, 45);
                const dpiaText = `1. Nature of Processing:\n${dpia.q1 || 'Not provided'}\n\n2. Necessity & Proportionality:\n${dpia.q2 || 'Not provided'}\n\n3. Risks to Individuals:\n${dpia.q3 || 'Not provided'}\n\n4. Mitigation Measures:\n${dpia.q4 || 'Not provided'}`;
                doc.setFontSize(10); doc.text(dpiaText, 14, 52, { maxWidth: 180 });
                
                // Page 2: Risk Register Table
                const tableData = risks.map(risk => {
                    const asset = assets.find(a => a.id === risk.assetId);
                    const { level } = getRiskLevel(risk.impact, risk.likelihood);
                    const justification = risk.treatment !== 'mitigate' ? (risk.justification || 'N/A') : 'N/A';
                    const controls = risk.treatment === 'mitigate' ? (risk.controls.join('\n') || 'None') : 'N/A';
                    const treatmentFormatted = risk.treatment.charAt(0).toUpperCase() + risk.treatment.slice(1);
                    return [ risk.riskId, asset ? asset.name : 'N/A', risk.description, level, treatmentFormatted, justification, controls ];
                });

                if (tableData.length > 0) {
                    doc.addPage();
                    doc.setFontSize(14); doc.text('ISO 27001 Risk Register', 14, 22);
                    doc.autoTable({ startY: 30, head: [['ID', 'Asset', 'Risk', 'Level', 'Treatment', 'Justification', 'Controls']], body: tableData, theme: 'grid', headStyles: { fillColor: [22, 163, 74] } });
                }
                
                doc.save(`${DataService.generateFilenameBase()}_Report.pdf`);
            },
            
            // Generates and downloads a CSV of the risk register.
            downloadCsv(isTemplate = false) {
                const headers = ["Risk ID", "Asset", "Risk Description", "Impact", "Likelihood", "Risk Score", "Risk Level", "Treatment", "Justification", "Selected Controls"];
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n';
                const escapeCSV = (field) => `"${(field || '').toString().replace(/"/g, '""')}"`;
                
                if (!isTemplate) {
                    AppState.data.risks.forEach(risk => {
                        const asset = AppState.data.assets.find(a => a.id === risk.assetId);
                        const riskScore = risk.impact * risk.likelihood;
                        const { level } = getRiskLevel(risk.impact, risk.likelihood);
                        const controls = risk.controls.join('; ');
                        const row = [risk.riskId, asset ? asset.name : 'N/A', risk.description, risk.impact, risk.likelihood, riskScore, level, risk.treatment, risk.justification, controls].map(escapeCSV).join(',');
                        csvContent += row + "\r\n";
                    });
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const filename = isTemplate ? "GRC-Risk-Register-Template.csv" : `${DataService.generateFilenameBase()}_Data.csv`;
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // --- EVENT HANDLERS MODULE --- //
        // This object centralizes all the event listeners for the application.
        // It acts as the "controller", responding to user input and calling methods
        // from the other modules.
        const EventHandlers = {
            // Sets up all the initial event listeners when the page loads.
            init() {
                document.getElementById('nextBtn').addEventListener('click', this.handleNextStep);
                document.getElementById('prevBtn').addEventListener('click', this.handlePrevStep);
                
                document.getElementById('saveBtn').addEventListener('click', () => DataService.saveSession());
                document.getElementById('jsonLoader').addEventListener('change', (e) => DataService.loadSession(e));
                document.getElementById('importCsvBtn').addEventListener('click', () => UIView.toggleModal(UIView.elements.importModal, true));
                document.getElementById('csvLoader').addEventListener('change', (e) => DataService.importFromCsv(e));
                document.getElementById('templateCsvBtn').addEventListener('click', () => DataService.downloadCsv(true));

                document.getElementById('addAssetBtn').addEventListener('click', this.handleAddAsset);
                document.getElementById('addRiskBtn').addEventListener('click', this.handleAddRisk);
                document.getElementById('findDuplicatesBtn').addEventListener('click', this.handleFindDuplicates);
                document.getElementById('clearHighlightsBtn').addEventListener('click', this.handleClearHighlights);

                // Modals
                document.getElementById('guideBtn').addEventListener('click', () => UIView.toggleModal(UIView.elements.guideModal, true));
                document.getElementById('closeGuideBtn').addEventListener('click', () => UIView.toggleModal(UIView.elements.guideModal, false));
                document.getElementById('cancelControlsBtn').addEventListener('click', () => UIView.toggleModal(UIView.elements.controlModal, false));
                document.getElementById('saveControlsBtn').addEventListener('click', this.handleSaveControls);
                document.getElementById('cancelImportBtn').addEventListener('click', () => UIView.toggleModal(UIView.elements.importModal, false));
                document.getElementById('confirmImportBtn').addEventListener('click', () => document.getElementById('csvLoader').click());
                UIView.elements.riskTreatmentSelect.addEventListener('change', (e) => UIView.updateTreatmentUI(e.target.value));
                
                // Listen for changes on all major text inputs to set the unsaved changes flag.
                ['ngoName', 'ngoMission', 'dpiaQ1', 'dpiaQ2', 'dpiaQ3', 'dpiaQ4'].forEach(id => {
                    document.getElementById(id).addEventListener('input', e => {
                        const key = id.startsWith('dpia') ? id.slice(-2).toLowerCase() : id;
                        if(id.startsWith('dpia')) { AppState.data.dpia[key] = e.target.value; }
                        else { AppState.data[key] = e.target.value; }
                        AppState.hasUnsavedChanges = true;
                    });
                });
                
                document.getElementById('downloadPdfBtn').addEventListener('click', () => DataService.downloadPdf());
                document.getElementById('downloadCsvBtn').addEventListener('click', () => DataService.downloadCsv(false));
                
                // Show a confirmation dialog if the user tries to leave with unsaved changes.
                window.addEventListener('beforeunload', (event) => {
                    if (AppState.hasUnsavedChanges) {
                        event.preventDefault();
                        event.returnValue = ''; // Required for legacy browsers.
                    }
                });
            },

            handleNextStep() {
                if (AppState.currentStep < AppState.totalSteps) {
                    AppState.currentStep++;
                    UIView.updateNavigation();
                    // If we've reached the final step, populate the review data.
                    if (AppState.currentStep === 4) {
                        UIView.populateReviewData();
                    }
                }
            },
            handlePrevStep() {
                if (AppState.currentStep > 1) {
                    AppState.currentStep--;
                    UIView.updateNavigation();
                }
            },
            handleAddAsset() {
                const assetInput = document.getElementById('assetInput');
                if (assetInput.value.trim()) {
                    AppState.data.assets.push({ 
                        id: crypto.randomUUID(), 
                        name: assetInput.value.trim(), 
                        category: document.getElementById('assetCategoryInput').value 
                    });
                    assetInput.value = ''; // Clear input
                    UIView.renderAssetList();
                    AppState.hasUnsavedChanges = true;
                }
            },
            handleSelectAsset(id, name) {
                document.getElementById('riskSection').style.display = 'block';
                document.getElementById('selectedAsset').textContent = name;
                document.getElementById('addRiskBtn').dataset.assetId = id;
                // Highlight the selected asset in the list.
                document.querySelectorAll('#assetList .list-item').forEach(el => {
                    el.classList.toggle('bg-sky-800', el.dataset.id == id);
                });
            },
            handleDeleteAsset(assetId, assetName) {
                if (confirm(`Are you sure you want to delete "${assetName}"? All associated risks will also be removed.`)) {
                    AppState.data.assets = AppState.data.assets.filter(a => a.id !== assetId);
                    AppState.data.risks = AppState.data.risks.filter(r => r.assetId !== assetId);
                    UIView.renderAssetList();
                    UIView.renderRiskTable();
                    document.getElementById('riskSection').style.display = 'none'; // Hide risk input
                    AppState.hasUnsavedChanges = true;
                }
            },
            handleAddRisk() {
                const assetId = document.getElementById('addRiskBtn').dataset.assetId;
                const riskDescEl = document.getElementById('riskDescription');
                const threatCat = document.getElementById('threatCategoryInput').value;
                const vulnCat = document.getElementById('vulnerabilityCategoryInput').value;
                
                // Basic validation
                if (assetId && riskDescEl.value.trim() && threatCat && vulnCat) {
                    const newRisk = {
                        id: crypto.randomUUID(),
                        riskId: `RISK-${String(AppState.riskCounter++).padStart(3, '0')}`,
                        assetId: assetId,
                        description: riskDescEl.value.trim(),
                        threatCat: threatCat, vulnCat: vulnCat,
                        impact: parseInt(document.getElementById('impactInput').value),
                        likelihood: parseInt(document.getElementById('likelihoodInput').value),
                        treatment: 'mitigate', // Default treatment
                        justification: '',
                        controls: []
                    };
                    AppState.data.risks.push(newRisk);
                    UIView.renderRiskTable();
                    riskDescEl.value = ''; // Clear input for next risk
                    // Immediately open the control modal for the new risk.
                    UIView.openControlModal(newRisk.id);
                    AppState.hasUnsavedChanges = true;
                } else {
                    UIView.showToast('Please select an asset and fill out all risk fields.', 'error');
                }
            },
            handleDeleteRisk(riskId) {
                if (confirm('Are you sure you want to delete this risk?')) {
                    AppState.data.risks = AppState.data.risks.filter(r => r.id !== riskId);
                    UIView.renderRiskTable();
                    AppState.hasUnsavedChanges = true;
                }
            },
            handleSaveControls() {
                const risk = AppState.data.risks.find(r => r.id === AppState.currentRiskIdForModal);
                if (!risk) return;

                risk.treatment = UIView.elements.riskTreatmentSelect.value;
                
                if (risk.treatment === 'mitigate') {
                    const selectedControls = [];
                    UIView.elements.controlModal.querySelectorAll('#allControlsList input:checked').forEach(checkbox => {
                        selectedControls.push(checkbox.value);
                    });
                    risk.controls = [...new Set(selectedControls)]; // Remove any duplicates
                    risk.justification = ''; // Clear justification if mitigating
                } else {
                    risk.justification = document.getElementById('riskJustification').value.trim();
                    risk.controls = []; // Clear controls if not mitigating
                }
                
                UIView.renderRiskTable();
                UIView.toggleModal(UIView.elements.controlModal, false);
                AppState.hasUnsavedChanges = true;
            },
            handleFindDuplicates() {
                const duplicateIds = DataService.findDuplicates();
                const clearBtn = document.getElementById('clearHighlightsBtn');
                if (duplicateIds.length > 0) {
                    UIView.showToast(`Found ${duplicateIds.length} risks that appear to be duplicates.`, 'info');
                    UIView.renderRiskTable(duplicateIds);
                    clearBtn.classList.remove('hidden');
                } else {
                    UIView.showToast('No duplicates found.', 'success');
                    UIView.renderRiskTable(); 
                    clearBtn.classList.add('hidden');
                }
            },
            handleClearHighlights() {
                UIView.renderRiskTable(); // Rerender the table without any highlights.
                document.getElementById('clearHighlightsBtn').classList.add('hidden');
            }
        };

        // --- INITIALIZATION --- //
        // This is where the magic happens! We set up the event listeners
        // and render the initial UI state.
        EventHandlers.init();
        UIView.updateNavigation();
    });
    </script>
</body>
</html>



